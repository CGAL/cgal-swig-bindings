name: Auto-refresh Dependabot PRs

# This workflow automatically refreshes (rebases) open Dependabot PRs
# when changes are pushed to the main branch.
# This helps keep dependency update PRs up to date with the latest main branch.

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

jobs:
  refresh-dependabot-prs:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get open Dependabot PRs
        id: get-prs
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            // Filter for Dependabot PRs with the 'dependencies' label
            const dependabotPRs = pullRequests.filter(pr => 
              pr.user.login === 'dependabot[bot]' &&
              pr.labels.some(label => label.name === 'dependencies')
            );
            
            console.log(`Found ${dependabotPRs.length} Dependabot PRs`);
            
            return dependabotPRs.map(pr => ({
              number: pr.number,
              title: pr.title
            }));
      
      - name: Rebase Dependabot PRs
        uses: actions/github-script@v7
        with:
          script: |
            const prs = ${{ steps.get-prs.outputs.result }};
            
            if (!prs || prs.length === 0) {
              console.log('No Dependabot PRs found to refresh');
              return;
            }
            
            for (const pr of prs) {
              console.log(`Refreshing PR #${pr.number}: ${pr.title}`);
              
              try {
                // Post a comment to trigger Dependabot rebase
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: '@dependabot rebase'
                });
                
                console.log(`✓ Successfully triggered rebase for PR #${pr.number}`);
                
                // Add a small delay between requests to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 2000));
                
              } catch (error) {
                console.error(`✗ Failed to refresh PR #${pr.number}: ${error.message}`);
              }
            }
            
            console.log('Finished refreshing Dependabot PRs');
